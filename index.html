
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Padel Academy Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .nav {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .nav-btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: linear-gradient(45deg, #4834d4, #686de0);
        }

        .page {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .page.active {
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 14px;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin: 5px;
        }

        .btn-secondary {
            background: linear-gradient(45deg, #a4b0be, #747d8c);
        }

        .btn-success {
            background: linear-gradient(45deg, #2ed573, #1e90ff);
        }

        .btn-danger {
            background: linear-gradient(45deg, #ff4757, #ff3838);
        }

        .table-container {
            overflow-x: auto;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin: 20px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e1e8ed;
        }

        th {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            font-weight: 600;
        }

        .hidden {
            display: none;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-paid {
            background: linear-gradient(45deg, #2ed573, #7bed9f);
            color: white;
        }

        .status-pending {
            background: linear-gradient(45deg, #ffa502, #ff6348);
            color: white;
        }

        .status-canceled {
            background: linear-gradient(45deg, #ff4757, #ff3838);
            color: white;
        }

        .status-free-session {
            background: linear-gradient(45deg, #747d8c, #a4b0be);
            color: white;
        }

        .status-package {
            background: linear-gradient(45deg, #5352ed, #3742fa);
            color: white;
        }

        .credit-indicator {
            background: linear-gradient(45deg, #5352ed, #3742fa);
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            margin-left: 5px;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 500;
        }

        .alert-success {
            background: linear-gradient(45deg, #2ed573, #7bed9f);
            color: white;
        }

        .alert-danger {
            background: linear-gradient(45deg, #ff4757, #ff6b7a);
            color: white;
        }

        .alert-warning {
            background: linear-gradient(45deg, #ffa502, #ff6348);
            color: white;
        }

        .alert-info {
            background: linear-gradient(45deg, #3742fa, #5352ed);
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background: white;
            margin: 2% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .report-filters {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .target-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .progress-bar {
            background: #e9ecef;
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .package-indicator {
            background: linear-gradient(45deg, #5352ed, #3742fa);
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            margin-left: 5px;
        }

        .calendar-day {
            position: relative;
            min-height: 100px;
        }

        .calendar-day.today {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
        }

        .calendar-day.other-month {
            background: #f8f9fa !important;
            color: #6c757d !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 style="text-align: center; margin-bottom: 20px; color: #333; font-size: 2.5em; font-weight: 700;">🎾 Padel Academy Management</h1>
            <div class="nav">
                <button class="nav-btn active" onclick="showPage('sessions')">Sessions</button>
                <button class="nav-btn" onclick="showPage('calendar')">Calendar</button>
                <button class="nav-btn" onclick="showPage('clients')">Clients</button>
                <button class="nav-btn" onclick="showPage('expenses')">Expenses</button>
                <button class="nav-btn" onclick="showPage('dashboard')">Dashboard</button>
                <button class="nav-btn" onclick="showPage('reports')">Reports</button>
                <button class="nav-btn" onclick="showPage('targets')">Targets</button>
                <button class="nav-btn" onclick="showPage('backup')">Backup</button>
            </div>
        </div>

        <!-- Sessions Page -->
        <div id="sessions" class="page active">
            <h2 style="margin-bottom: 30px; color: #333;">📋 Session Management</h2>
            
            <div style="display: flex; gap: 15px; margin-bottom: 30px; flex-wrap: wrap;">
                <button class="btn" onclick="showAddSessionForm()">➕ Add New Session</button>
                <button class="btn btn-success" onclick="exportSessions()">📊 Export Sessions</button>
            </div>

            <div id="addSessionForm" class="hidden" style="background: #f8f9fa; padding: 25px; border-radius: 15px; margin-bottom: 30px;">
                <h3 style="margin-bottom: 20px; color: #333;">Add New Session</h3>
                <form onsubmit="addSession(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Date:</label>
                            <input type="date" id="sessionDate" required>
                        </div>
                        <div class="form-group">
                            <label>Time:</label>
                            <input type="time" id="sessionTime" required>
                        </div>
                        <div class="form-group">
                            <label>Location:</label>
                            <select id="location" required>
                                <option value="">Select Location</option>
                                <option value="Top Padel">Top Padel</option>
                                <option value="Champs">Champs</option>
                                <option value="Padel Art">Padel Art</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group hidden" id="customLocationGroup">
                            <label>Custom Location:</label>
                            <input type="text" id="customLocation">
                        </div>
                        <div class="form-group">
                            <label>Session Type:</label>
                            <select id="sessionType" required>
                                <option value="">Select Type</option>
                                <option value="Group Session">Group Session</option>
                                <option value="Private">Private</option>
                                <option value="Networking">Networking</option>
                                <option value="Tournament">Tournament</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Duration (hours):</label>
                            <select id="duration" required>
                                <option value="">Select Duration</option>
                                <option value="0.5">30 minutes</option>
                                <option value="1">1 hour</option>
                                <option value="1.5">1.5 hours</option>
                                <option value="2">2 hours</option>
                                <option value="2.5">2.5 hours</option>
                                <option value="3">3 hours</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Instructor Name:</label>
                            <input type="text" id="instructorName" required>
                        </div>
                        <div class="form-group">
                            <label>Client:</label>
                            <select id="clientSelect" required onchange="handleClientSelection()">
                                <option value="">Select Client</option>
                                <option value="new_client">➕ Add New Client</option>
                            </select>
                        </div>
                        <div class="form-group hidden" id="newClientGroup">
                            <label>New Client Name:</label>
                            <input type="text" id="newClientName">
                        </div>
                        <div class="form-group">
                            <label>Payment Method:</label>
                            <select id="paymentMethod" required onchange="handlePaymentMethodChange()">
                                <option value="">Select Method</option>
                                <option value="Cash">Cash</option>
                                <option value="Card">Card</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                                <option value="Mobile Payment">Mobile Payment</option>
                                <option value="Package">Package</option>
                            </select>
                        </div>
                        <div class="form-group hidden" id="packageGroup">
                            <label>Select Package:</label>
                            <select id="packageSelect">
                                <option value="">Select Package</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Payment Status:</label>
                            <select id="paymentStatus" required>
                                <option value="">Select Status</option>
                                <option value="Paid">Paid</option>
                                <option value="Pending">Pending</option>
                                <option value="Free Session">Free Session</option>
                                <option value="Canceled">Canceled</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Price per Hour:</label>
                            <input type="number" id="pricePerHour" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Number of Students:</label>
                            <input type="number" id="numberOfStudents" min="1" required>
                        </div>
                        <div class="form-group">
                            <label>Court Cost per Hour:</label>
                            <input type="number" id="courtCostPerHour" step="0.01" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notes:</label>
                        <textarea id="sessionNotes" rows="3"></textarea>
                    </div>
                    <div style="display: flex; gap: 15px; margin-top: 20px;">
                        <button type="submit" class="btn">💾 Save Session</button>
                        <button type="button" class="btn btn-secondary" onclick="hideAddSessionForm()">❌ Cancel</button>
                    </div>
                </form>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Session ID</th>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Client</th>
                            <th>Location</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Payment</th>
                            <th>Revenue</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="sessionsTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Calendar Page -->
        <div id="calendar" class="page">
            <h2 style="margin-bottom: 30px; color: #333;">📅 Session Calendar</h2>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 15px;">
                <div>
                    <button class="btn btn-secondary" onclick="previousMonth()">◀ Previous</button>
                    <span id="currentMonthYear" style="margin: 0 20px; font-weight: bold;"></span>
                    <button class="btn btn-secondary" onclick="nextMonth()">Next ▶</button>
                </div>
                <div>
                    <select id="calendarClientFilter" onchange="renderCalendar()">
                        <option value="">All Clients</option>
                    </select>
                    <button class="btn" onclick="goToToday()">Today</button>
                </div>
            </div>

            <div id="calendarContainer" style="background: white; border-radius: 15px; padding: 20px;">
                <!-- Calendar will be rendered here -->
            </div>
        </div>

        <!-- Clients Page -->
        <div id="clients" class="page">
            <h2 style="margin-bottom: 30px; color: #333;">👥 Client Management</h2>
            
            <div style="display: flex; gap: 15px; margin-bottom: 30px; flex-wrap: wrap;">
                <button class="btn" onclick="showAddClientForm()">➕ Add New Client</button>
                <button class="btn btn-success" onclick="exportClients()">📊 Export Clients</button>
            </div>

            <div id="addClientForm" class="hidden" style="background: #f8f9fa; padding: 25px; border-radius: 15px; margin-bottom: 30px;">
                <h3 style="margin-bottom: 20px; color: #333;">Add New Client</h3>
                <form onsubmit="addClient(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Client Name:</label>
                            <input type="text" id="clientName" required>
                        </div>
                        <div class="form-group">
                            <label>Email:</label>
                            <input type="email" id="clientEmail" required>
                        </div>
                        <div class="form-group">
                            <label>Phone:</label>
                            <input type="tel" id="clientPhone" required>
                        </div>
                        <div class="form-group">
                            <label>Lead Source:</label>
                            <select id="clientLeadSource">
                                <option value="Recurring Client">Recurring Client</option>
                                <option value="Social Media">Social Media</option>
                                <option value="Word of Mouth">Word of Mouth</option>
                                <option value="Website">Website</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notes:</label>
                        <textarea id="clientNotes" rows="3"></textarea>
                    </div>
                    <div style="display: flex; gap: 15px; margin-top: 20px;">
                        <button type="submit" class="btn">💾 Save Client</button>
                        <button type="button" class="btn btn-secondary" onclick="hideAddClientForm()">❌ Cancel</button>
                    </div>
                </form>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Sessions</th>
                            <th>Credit Balance</th>
                            <th>Package Balance</th>
                            <th>Total Spent</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="clientsTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Expenses Page -->
        <div id="expenses" class="page">
            <h2 style="margin-bottom: 30px; color: #333;">💰 Expenses</h2>
            
            <div style="display: flex; gap: 15px; margin-bottom: 30px; flex-wrap: wrap;">
                <button class="btn" onclick="showAddExpenseForm()">➕ Add Expense</button>
                <button class="btn btn-success" onclick="exportExpenses()">📊 Export Expenses</button>
            </div>

            <div id="addExpenseForm" class="hidden" style="background: #f8f9fa; padding: 25px; border-radius: 15px; margin-bottom: 30px;">
                <h3 style="margin-bottom: 20px; color: #333;">Add New Expense</h3>
                <form onsubmit="addExpense(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Date:</label>
                            <input type="date" id="expenseDate" required>
                        </div>
                        <div class="form-group">
                            <label>Category:</label>
                            <select id="expenseCategory" required>
                                <option value="">Select Category</option>
                                <option value="Court Rental">Court Rental</option>
                                <option value="Equipment">Equipment</option>
                                <option value="Marketing">Marketing</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Amount:</label>
                            <input type="number" id="expenseAmount" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Description:</label>
                            <input type="text" id="expenseDescription" required>
                        </div>
                    </div>
                    <div style="display: flex; gap: 15px; margin-top: 20px;">
                        <button type="submit" class="btn">💾 Save Expense</button>
                        <button type="button" class="btn btn-secondary" onclick="hideAddExpenseForm()">❌ Cancel</button>
                    </div>
                </form>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Category</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="expensesTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Dashboard Page -->
        <div id="dashboard" class="page">
            <h2 style="margin-bottom: 30px; color: #333;">📊 Dashboard</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalSessions">0</div>
                    <div class="stat-label">Total Sessions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalRevenue">AED 0</div>
                    <div class="stat-label">Total Revenue</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalProfit">AED 0</div>
                    <div class="stat-label">Net Profit</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalClients">0</div>
                    <div class="stat-label">Total Clients</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalCredits">AED 0</div>
                    <div class="stat-label">Client Credits</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalPackages">AED 0</div>
                    <div class="stat-label">Package Balance</div>
                </div>
            </div>
        </div>

        <!-- Targets Page -->
        <div id="targets" class="page">
            <h2 style="margin-bottom: 30px; color: #333;">🎯 Targets</h2>
            
            <div style="display: flex; gap: 15px; margin-bottom: 30px; flex-wrap: wrap;">
                <button class="btn" onclick="showAddTargetForm()">➕ Set New Target</button>
            </div>

            <div id="addTargetForm" class="hidden" style="background: #f8f9fa; padding: 25px; border-radius: 15px; margin-bottom: 30px;">
                <h3 style="margin-bottom: 20px; color: #333;">Set New Target</h3>
                <form onsubmit="addTarget(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Target Type:</label>
                            <select id="targetType" required>
                                <option value="">Select Type</option>
                                <option value="sessions">Sessions</option>
                                <option value="revenue">Revenue</option>
                                <option value="profit">Profit</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Period:</label>
                            <select id="targetPeriod" required>
                                <option value="">Select Period</option>
                                <option value="quarterly">Quarterly</option>
                                <option value="yearly">Yearly</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Year:</label>
                            <input type="number" id="targetYear" min="2024" max="2030" required>
                        </div>
                        <div class="form-group" id="quarterGroup">
                            <label>Quarter:</label>
                            <select id="targetQuarter">
                                <option value="">Select Quarter</option>
                                <option value="1">Q1 (Jan-Mar)</option>
                                <option value="2">Q2 (Apr-Jun)</option>
                                <option value="3">Q3 (Jul-Sep)</option>
                                <option value="4">Q4 (Oct-Dec)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Target Value:</label>
                            <input type="number" id="targetValue" step="0.01" required>
                        </div>
                    </div>
                    <div style="display: flex; gap: 15px; margin-top: 20px;">
                        <button type="submit" class="btn">💾 Save Target</button>
                        <button type="button" class="btn btn-secondary" onclick="hideAddTargetForm()">❌ Cancel</button>
                    </div>
                </form>
            </div>

            <div id="targetsContainer">
                <!-- Targets will be rendered here -->
            </div>
        </div>

        <!-- Reports Page -->
        <div id="reports" class="page">
            <h2 style="margin-bottom: 30px; color: #333;">📈 Reports</h2>
            
            <div class="report-filters">
                <h3>Generate Reports</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <h4>Sessions Reports</h4>
                        <select id="sessionsReportType">
                            <option value="monthly">Sessions per Month</option>
                            <option value="yearly">Sessions per Year</option>
                            <option value="location">Sessions by Location</option>
                            <option value="timing">Session Timing Analysis</option>
                        </select>
                        <div style="margin-top: 10px;">
                            <input type="number" id="reportYear" placeholder="Year (e.g., 2024)" min="2020" max="2030">
                            <select id="reportMonth" style="display:none;">
                                <option value="">All Months</option>
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                        </div>
                        <div style="margin-top: 10px;">
                            <button class="btn" onclick="generateSessionsReport()">Generate Report</button>
                            <button class="btn btn-success" onclick="downloadReportExcel()">Download Excel</button>
                            <button class="btn btn-secondary" onclick="downloadReportPDF()">Download PDF</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <h4>Financial Reports</h4>
                        <button class="btn" onclick="generateFinancialReport()">Financial Report</button>
                        <button class="btn" onclick="generatePendingPayments()">Pending Payments</button>
                        <button class="btn" onclick="generateTargetProgressReport()">Target Progress</button>
                    </div>
                </div>
            </div>

            <div id="reportResults" class="hidden" style="margin-top: 30px;">
                <h3>Report Results</h3>
                <div id="reportContent"></div>
            </div>
        </div>

        <!-- Backup Page -->
        <div id="backup" class="page">
            <h2 style="margin-bottom: 30px; color: #333;">💾 Backup & Sync</h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <h3>🌐 Free Cloud Sync</h3>
                    <button class="btn btn-success" onclick="showCloudSetup()">Setup Cloud Sync</button>
                    <p style="color: #666; font-size: 0.9em; margin-top: 10px;">
                        ✅ 100% Free using GitHub<br>
                        ✅ Sync across all devices<br>
                        ✅ Automatic backup<br>
                        ✅ Private & secure
                    </p>
                </div>
                
                <div class="form-group">
                    <h3>Local Backup</h3>
                    <button class="btn" onclick="backupAllData()">📤 Download Backup</button>
                    <button class="btn btn-secondary" onclick="restoreData()">📥 Restore Data</button>
                    <input type="file" id="restoreFile" accept=".json" style="display: none;" onchange="handleRestore(event)">
                </div>
                
                <div class="form-group">
                    <h3>Export Options</h3>
                    <button class="btn" onclick="exportSessions()">📊 Export Sessions</button>
                    <button class="btn" onclick="exportClients()">👥 Export Clients</button>
                    <button class="btn" onclick="exportExpenses()">💰 Export Expenses</button>
                </div>
                
                <div class="form-group">
                    <h3>Data Management</h3>
                    <button class="btn btn-danger" onclick="clearAllData()">🗑️ Clear All Data</button>
                    <p style="color: #666; font-size: 0.9em; margin-top: 10px;">⚠️ This will delete all data permanently!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Credit Management Modal -->
    <div id="creditModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCreditModal()">&times;</span>
            <h3>Manage Client Credit & Packages</h3>
            <div id="creditContent"></div>
        </div>
    </div>

    <!-- Edit Session Modal -->
    <div id="editSessionModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditSessionModal()">&times;</span>
            <h3>Edit Session</h3>
            <div id="editSessionContent">
                <form onsubmit="updateSession(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Date:</label>
                            <input type="date" id="editSessionDate" required>
                        </div>
                        <div class="form-group">
                            <label>Time:</label>
                            <input type="time" id="editSessionTime" required>
                        </div>
                        <div class="form-group">
                            <label>Location:</label>
                            <select id="editLocation" required>
                                <option value="">Select Location</option>
                                <option value="Top Padel">Top Padel</option>
                                <option value="Champs">Champs</option>
                                <option value="Padel Art">Padel Art</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group hidden" id="editCustomLocationGroup">
                            <label>Custom Location:</label>
                            <input type="text" id="editCustomLocation">
                        </div>
                        <div class="form-group">
                            <label>Session Type:</label>
                            <select id="editSessionType" required>
                                <option value="">Select Type</option>
                                <option value="Group Session">Group Session</option>
                                <option value="Private">Private</option>
                                <option value="Networking">Networking</option>
                                <option value="Tournament">Tournament</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Duration (hours):</label>
                            <select id="editDuration" required>
                                <option value="">Select Duration</option>
                                <option value="0.5">30 minutes</option>
                                <option value="1">1 hour</option>
                                <option value="1.5">1.5 hours</option>
                                <option value="2">2 hours</option>
                                <option value="2.5">2.5 hours</option>
                                <option value="3">3 hours</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Instructor Name:</label>
                            <input type="text" id="editInstructorName" required>
                        </div>
                        <div class="form-group">
                            <label>Client:</label>
                            <select id="editClientSelect" required>
                                <option value="">Select Client</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Payment Method:</label>
                            <select id="editPaymentMethod" required>
                                <option value="">Select Method</option>
                                <option value="Cash">Cash</option>
                                <option value="Card">Card</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                                <option value="Mobile Payment">Mobile Payment</option>
                                <option value="Package">Package</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Payment Status:</label>
                            <select id="editPaymentStatus" required>
                                <option value="">Select Status</option>
                                <option value="Paid">Paid</option>
                                <option value="Pending">Pending</option>
                                <option value="Free Session">Free Session</option>
                                <option value="Canceled">Canceled</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Price per Hour:</label>
                            <input type="number" id="editPricePerHour" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Number of Students:</label>
                            <input type="number" id="editNumberOfStudents" min="1" required>
                        </div>
                        <div class="form-group">
                            <label>Court Cost per Hour:</label>
                            <input type="number" id="editCourtCostPerHour" step="0.01" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notes:</label>
                        <textarea id="editSessionNotes" rows="3"></textarea>
                    </div>
                    <input type="hidden" id="editSessionId">
                    <div style="display: flex; gap: 15px; margin-top: 20px;">
                        <button type="submit" class="btn">💾 Update Session</button>
                        <button type="button" class="btn btn-secondary" onclick="closeEditSessionModal()">❌ Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Simple Cloud Storage using GitHub Gist API (FREE)
        class SimpleCloudStorage {
            constructor() {
                this.token = localStorage.getItem('github_token');
                this.gistId = localStorage.getItem('gist_id');
                this.username = localStorage.getItem('github_username');
            }
            
            // One-time setup for user
            async setup() {
                const username = prompt('Enter your GitHub username:');
                const token = prompt('Enter your GitHub Personal Access Token\n\nTo create one:\n1. Go to github.com/settings/tokens\n2. Click "Generate new token (classic)"\n3. Give it a name like "Padel Academy"\n4. Check "gist" permission\n5. Click "Generate token"\n6. Copy the token here:');
                
                if (!username || !token) {
                    alert('Setup cancelled. You can set this up later by clicking the sync status indicator.');
                    return false;
                }
                
                localStorage.setItem('github_username', username);
                localStorage.setItem('github_token', token);
                this.username = username;
                this.token = token;
                
                // Create initial gist
                await this.createInitialGist();
                return true;
            }
            
            async createInitialGist() {
                const initialData = {
                    sessions,
                    clients,
                    expenses,
                    targets,
                    nextSessionId,
                    lastUpdated: new Date().toISOString()
                };
                
                const gistData = {
                    description: 'Padel Academy Data - Private Storage',
                    public: false,
                    files: {
                        'padel_data.json': {
                            content: JSON.stringify(initialData, null, 2)
                        }
                    }
                };
                
                try {
                    const response = await fetch('https://api.github.com/gists', {
                        method: 'POST',
                        headers: {
                            'Authorization': `token ${this.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(gistData)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        this.gistId = result.id;
                        localStorage.setItem('gist_id', this.gistId);
                        showAlert('Cloud storage setup complete! Your data will now sync across devices.', 'success');
                        return true;
                    } else {
                        throw new Error('Failed to create gist');
                    }
                } catch (error) {
                    console.error('Setup failed:', error);
                    alert('Setup failed. Please check your token has "gist" permission and try again.');
                }
                return false;
            }
            
            async saveData() {
                if (!this.token || !this.gistId) {
                    // Fallback to localStorage if not set up
                    localStorage.setItem('sessions', JSON.stringify(sessions));
                    localStorage.setItem('clients', JSON.stringify(clients));
                    localStorage.setItem('expenses', JSON.stringify(expenses));
                    localStorage.setItem('targets', JSON.stringify(targets));
                    localStorage.setItem('nextSessionId', nextSessionId.toString());
                    return;
                }
                
                const dataToSave = {
                    sessions,
                    clients,
                    expenses,
                    targets,
                    nextSessionId,
                    lastUpdated: new Date().toISOString()
                };
                
                try {
                    const response = await fetch(`https://api.github.com/gists/${this.gistId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `token ${this.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            files: {
                                'padel_data.json': {
                                    content: JSON.stringify(dataToSave, null, 2)
                                }
                            }
                        })
                    });
                    
                    if (response.ok) {
                        console.log('Data saved to cloud successfully');
                        updateSyncIndicator('synced');
                        localStorage.setItem('lastSyncTime', new Date().toISOString());
                    }
                } catch (error) {
                    console.error('Cloud save failed:', error);
                    updateSyncIndicator('error');
                    // Fallback to localStorage
                    localStorage.setItem('sessions', JSON.stringify(sessions));
                    localStorage.setItem('clients', JSON.stringify(clients));
                    localStorage.setItem('expenses', JSON.stringify(expenses));
                    localStorage.setItem('targets', JSON.stringify(targets));
                    localStorage.setItem('nextSessionId', nextSessionId.toString());
                }
            }
            
            async loadData() {
                if (!this.token || !this.gistId) {
                    // Load from localStorage
                    return {
                        sessions: JSON.parse(localStorage.getItem('sessions') || '[]'),
                        clients: JSON.parse(localStorage.getItem('clients') || '[]'),
                        expenses: JSON.parse(localStorage.getItem('expenses') || '[]'),
                        targets: JSON.parse(localStorage.getItem('targets') || '[]'),
                        nextSessionId: parseInt(localStorage.getItem('nextSessionId') || '1')
                    };
                }
                
                try {
                    const response = await fetch(`https://api.github.com/gists/${this.gistId}`, {
                        headers: {
                            'Authorization': `token ${this.token}`
                        }
                    });
                    
                    if (response.ok) {
                        const gist = await response.json();
                        const content = gist.files['padel_data.json'].content;
                        const data = JSON.parse(content);
                        console.log('Data loaded from cloud successfully');
                        updateSyncIndicator('synced');
                        return data;
                    }
                } catch (error) {
                    console.error('Cloud load failed:', error);
                    updateSyncIndicator('error');
                }
                
                // Fallback to localStorage
                return {
                    sessions: JSON.parse(localStorage.getItem('sessions') || '[]'),
                    clients: JSON.parse(localStorage.getItem('clients') || '[]'),
                    expenses: JSON.parse(localStorage.getItem('expenses') || '[]'),
                    targets: JSON.parse(localStorage.getItem('targets') || '[]'),
                    nextSessionId: parseInt(localStorage.getItem('nextSessionId') || '1')
                };
            }
            
            isSetup() {
                return !!(this.token && this.gistId);
            }
            
            async resetSetup() {
                if (confirm('This will reset cloud sync setup. You will need to set it up again. Continue?')) {
                    localStorage.removeItem('github_token');
                    localStorage.removeItem('gist_id');
                    localStorage.removeItem('github_username');
                    this.token = null;
                    this.gistId = null;
                    this.username = null;
                    showSyncStatus();
                    showAlert('Cloud sync reset. Click the indicator to set up again.', 'info');
                }
            }
        }

        // Initialize cloud storage
        const cloudStorage = new SimpleCloudStorage();

        // Global variables
        let sessions = [];
        let clients = [];
        let expenses = [];
        let targets = [];
        let nextSessionId = 1;
        let currentCalendarDate = new Date();
        let currentReportData = null;

        // Modified data loading and saving functions
        async function loadAllData() {
            try {
                const data = await cloudStorage.loadData();
                sessions = data.sessions || [];
                clients = data.clients || [];
                expenses = data.expenses || [];
                targets = data.targets || [];
                nextSessionId = data.nextSessionId || 1;
                
                populateClientDropdowns();
                updateDashboard();
                renderCalendar();
                
            } catch (error) {
                console.error('Error loading data:', error);
                showAlert('Error loading data', 'danger');
            }
        }

        function autoSave() {
            // Debounce saves to avoid too many requests
            clearTimeout(autoSave.timeout);
            autoSave.timeout = setTimeout(() => {
                cloudStorage.saveData();
            }, 2000);
        }

        // Cloud setup functions
        function showCloudSetup() {
            if (cloudStorage.isSetup()) {
                const lastSync = localStorage.getItem('lastSyncTime');
                const syncTime = lastSync ? new Date(lastSync).toLocaleString() : 'Never';
                
                if (confirm(`Cloud sync is active!\n\nLast sync: ${syncTime}\n\nOptions:\n- OK: Test sync now\n- Cancel: Reset setup`)) {
                    cloudStorage.saveData();
                    showAlert('Sync test completed!', 'success');
                } else {
                    cloudStorage.resetSetup();
                }
                return;
            }
            
            const setupInstructions = `🌐 FREE Cloud Sync Setup

This will sync your data across all devices using GitHub (100% free).

Steps:
1. Go to github.com/settings/tokens
2. Click "Generate new token (classic)"
3. Give it a name like "Padel Academy"
4. Check ONLY the "gist" permission
5. Click "Generate token"
6. Copy the token (you won't see it again!)

Ready to set up now?`;
            
            if (confirm(setupInstructions)) {
                cloudStorage.setup().then(success => {
                    if (success) {
                        cloudStorage.saveData(); // Sync current data
                        showSyncStatus(); // Update indicator
                    }
                });
            }
        }

        // Sync status indicator
        function showSyncStatus() {
            // Remove existing indicator
            const existing = document.getElementById('syncIndicator');
            if (existing) existing.remove();
            
            const indicator = document.createElement('div');
            indicator.id = 'syncIndicator';
            indicator.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 8px 12px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 600;
                z-index: 1000;
                transition: all 0.3s ease;
                cursor: pointer;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            `;
            
            updateSyncIndicator();
            indicator.onclick = showCloudSetup;
            
            document.body.appendChild(indicator);
        }

        function updateSyncIndicator(status) {
            const indicator = document.getElementById('syncIndicator');
            if (!indicator) return;
            
            if (cloudStorage.isSetup()) {
                if (status === 'synced') {
                    indicator.textContent = '☁️ Synced';
                    indicator.style.background = '#2ed573';
                    indicator.style.color = 'white';
                    indicator.title = 'Click to test sync or reset';
                } else if (status === 'error') {
                    indicator.textContent = '⚠️ Sync Error';
                    indicator.style.background = '#ff4757';
                    indicator.style.color = 'white';
                    indicator.title = 'Click to retry or reset';
                } else {
                    indicator.textContent = '☁️ Cloud Ready';
                    indicator.style.background = '#3742fa';
                    indicator.style.color = 'white';
                    indicator.title = 'Click to test sync';
                }
            } else {
                indicator.textContent = '📱 Local Only';
                indicator.style.background = '#ffa502';
                indicator.style.color = 'white';
                indicator.title = 'Click to set up free cloud sync';
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', async function() {
            // Set default dates
            const today = new Date();
            const localDate = new Date(today.getTime() - (today.getTimezoneOffset() * 60000));
            const dateString = localDate.toISOString().split('T')[0];
            
            document.getElementById('sessionDate').value = dateString;
            document.getElementById('expenseDate').value = dateString;
            document.getElementById('targetYear').value = today.getFullYear();
            document.getElementById('reportYear').value = today.getFullYear();
            
            // Setup event listeners
            setupEventListeners();
            
            // Load data (from cloud or local)
            await loadAllData();
            
            // Show sync status indicator
            showSyncStatus();
            
            // Setup periodic sync check (every 5 minutes)
            setInterval(async () => {
                if (cloudStorage.isSetup()) {
                    try {
                        const cloudData = await cloudStorage.loadData();
                        const localLastUpdated = localStorage.getItem('lastSyncTime') || '2020-01-01';
                        const cloudLastUpdated = cloudData.lastUpdated || '2020-01-01';
                        
                        if (new Date(cloudLastUpdated) > new Date(localLastUpdated)) {
                            // Cloud has newer data, load it
                            sessions = cloudData.sessions || [];
                            clients = cloudData.clients || [];
                            expenses = cloudData.expenses || [];
                            targets = cloudData.targets || [];
                            nextSessionId = cloudData.nextSessionId || 1;
                            
                            // Refresh displays
                            loadSessions();
                            loadClients();
                            loadExpenses();
                            renderTargets();
                            populateClientDropdowns();
                            updateDashboard();
                            renderCalendar();
                            
                            showAlert('Data updated from another device!', 'info');
                        }
                    } catch (error) {
                        console.error('Periodic sync check failed:', error);
                    }
                }
            }, 5 * 60 * 1000); // 5 minutes
        });

        // Add this to your backup page
        function addCloudSyncToBackupPage() {
            const backupPage = document.getElementById('backup');
            if (backupPage && !document.getElementById('cloudSyncSection')) {
                const cloudSection = document.createElement('div');
                cloudSection.id = 'cloudSyncSection';
                cloudSection.innerHTML = `
                    <div class="form-group">
                        <h3>🌐 Free Cloud Sync</h3>
                        <button class="btn btn-success" onclick="showCloudSetup()">Setup Cloud Sync</button>
                        <p style="color: #666; font-size: 0.9em; margin-top: 10px;">
                            ✅ 100% Free using GitHub<br>
                            ✅ Sync across all devices<br>
                            ✅ Automatic backup<br>
                            ✅ Private & secure
                        </p>
                    </div>
                `;
                backupPage.querySelector('.form-grid').appendChild(cloudSection);
            }
        }

        function setupEventListeners() {
            document.getElementById('location').addEventListener('change', function() {
                const customGroup = document.getElementById('customLocationGroup');
                if (this.value === 'Other') {
                    customGroup.classList.remove('hidden');
                } else {
                    customGroup.classList.add('hidden');
                }
            });

            document.getElementById('targetPeriod').addEventListener('change', function() {
                const quarterGroup = document.getElementById('quarterGroup');
                if (this.value === 'quarterly') {
                    quarterGroup.classList.remove('hidden');
                    document.getElementById('targetQuarter').required = true;
                } else {
                    quarterGroup.classList.add('hidden');
                    document.getElementById('targetQuarter').required = false;
                }
            });

            document.getElementById('sessionsReportType').addEventListener('change', function() {
                const monthSelect = document.getElementById('reportMonth');
                if (this.value === 'monthly') {
                    monthSelect.style.display = 'inline';
                } else {
                    monthSelect.style.display = 'none';
                }
            });
        }

        // Fixed date handling functions
        function getLocalDateString(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function parseLocalDate(dateString) {
            const [year, month, day] = dateString.split('-').map(Number);
            return new Date(year, month - 1, day);
        }

        function formatDateForDisplay(dateString) {
            const date = parseLocalDate(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // Generate session ID in PA-XXX format
        function generateSessionId() {
            const id = 'PA-' + String(nextSessionId).padStart(3, '0');
            nextSessionId++;
            localStorage.setItem('nextSessionId', nextSessionId.toString());
            return id;
        }

        // Navigation
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            if (pageId === 'dashboard') updateDashboard();
            if (pageId === 'calendar') renderCalendar();
            if (pageId === 'targets') renderTargets();
        }

        // Package Management
        function handlePaymentMethodChange() {
            const paymentMethod = document.getElementById('paymentMethod').value;
            const packageGroup = document.getElementById('packageGroup');
            
            if (paymentMethod === 'Package') {
                packageGroup.classList.remove('hidden');
                populatePackages();
            } else {
                packageGroup.classList.add('hidden');
            }
        }

        function populatePackages() {
            const clientName = document.getElementById('clientSelect').value;
            const packageSelect = document.getElementById('packageSelect');
            packageSelect.innerHTML = '<option value="">Select Package</option>';
            
            const client = clients.find(c => c.name === clientName);
            if (client && client.packages) {
                client.packages.forEach(pkg => {
                    if (pkg.balance > 0) {
                        const option = document.createElement('option');
                        option.value = pkg.id;
                        option.textContent = `${pkg.name} (${pkg.balance} sessions left)`;
                        packageSelect.appendChild(option);
                    }
                });
            }
        }

        // Session Management
        function showAddSessionForm() {
            document.getElementById('addSessionForm').classList.remove('hidden');
            populateClientDropdowns();
        }

        function hideAddSessionForm() {
            document.getElementById('addSessionForm').classList.add('hidden');
            document.querySelector('#addSessionForm form').reset();
            document.getElementById('newClientGroup').classList.add('hidden');
            document.getElementById('customLocationGroup').classList.add('hidden');
            document.getElementById('packageGroup').classList.add('hidden');
            
            // Reset date to today
            const today = new Date();
            const localDate = new Date(today.getTime() - (today.getTimezoneOffset() * 60000));
            document.getElementById('sessionDate').value = localDate.toISOString().split('T')[0];
        }

        function handleClientSelection() {
            const clientSelect = document.getElementById('clientSelect');
            const newClientGroup = document.getElementById('newClientGroup');
            
            if (clientSelect.value === 'new_client') {
                newClientGroup.classList.remove('hidden');
            } else {
                newClientGroup.classList.add('hidden');
                if (document.getElementById('paymentMethod').value === 'Package') {
                    populatePackages();
                }
            }
        }

        function addSession(event) {
            event.preventDefault();
            
            let clientName;
            const clientSelect = document.getElementById('clientSelect');
            
            if (clientSelect.value === 'new_client') {
                clientName = document.getElementById('newClientName').value;
                if (!clientName) {
                    showAlert('Please enter client name', 'danger');
                    return;
                }
                
                // Create new client
                const newClient = {
                    id: Date.now(),
                    name: clientName,
                    email: '',
                    phone: '',
                    leadSource: 'New Client',
                    notes: 'Created from session',
                    creditBalance: 0,
                    packages: [],
                    createdDate: getLocalDateString(new Date())
                };
                clients.push(newClient);
                localStorage.setItem('clients', JSON.stringify(clients));
                populateClientDropdowns();
            } else {
                clientName = clientSelect.value;
            }

            const location = document.getElementById('location').value === 'Other' 
                ? document.getElementById('customLocation').value 
                : document.getElementById('location').value;

            const paymentMethod = document.getElementById('paymentMethod').value;
            let packageUsed = null;
            
            // Handle package payment
            if (paymentMethod === 'Package') {
                const packageId = document.getElementById('packageSelect').value;
                if (!packageId) {
                    showAlert('Please select a package', 'danger');
                    return;
                }
                
                const client = clients.find(c => c.name === clientName);
                packageUsed = client.packages.find(p => p.id === packageId);
                
                if (!packageUsed || packageUsed.balance <= 0) {
                    showAlert('Package not available or insufficient balance', 'danger');
                    return;
                }
            }

            const session = {
                id: Date.now(),
                sessionId: generateSessionId(),
                date: document.getElementById('sessionDate').value,
                time: document.getElementById('sessionTime').value,
                location: location,
                sessionType: document.getElementById('sessionType').value,
                duration: parseFloat(document.getElementById('duration').value),
                instructorName: document.getElementById('instructorName').value,
                clientName: clientName,
                paymentMethod: paymentMethod,
                paymentStatus: document.getElementById('paymentStatus').value,
                pricePerHour: parseFloat(document.getElementById('pricePerHour').value),
                numberOfStudents: parseInt(document.getElementById('numberOfStudents').value),
                courtCostPerHour: parseFloat(document.getElementById('courtCostPerHour').value),
                notes: document.getElementById('sessionNotes').value,
                packageUsed: packageUsed ? packageUsed.id : null,
                totalRevenue: 0,
                netProfit: 0
            };

            // Calculate financials
            calculateSessionFinancials(session);
            
            // Handle package deduction
            if (packageUsed) {
                packageUsed.balance -= 1;
                localStorage.setItem('clients', JSON.stringify(clients));
            }
            
            // Handle canceled sessions with credits
            if (session.paymentStatus === 'Canceled' && session.totalRevenue > 0) {
                addCreditToClient(session.clientName, session.totalRevenue);
            }

            sessions.push(session);
            localStorage.setItem('sessions', JSON.stringify(sessions));
            localStorage.setItem('nextSessionId', nextSessionId.toString());
            
            loadSessions();
            hideAddSessionForm();
            updateDashboard();
            renderCalendar();
            showAlert('Session added successfully!', 'success');
            
            // Auto-save to cloud
            autoSave();
        }

        function calculateSessionFinancials(session) {
            if (session.paymentStatus === 'Free Session' || session.paymentStatus === 'Canceled') {
                session.totalRevenue = 0;
            } else if (session.paymentMethod === 'Package') {
                // For package sessions, revenue is 0 as it's already paid
                session.totalRevenue = 0;
            } else {
                session.totalRevenue = session.duration * session.pricePerHour;
            }
            
            const totalCourtCost = session.duration * session.courtCostPerHour;
            session.netProfit = session.totalRevenue - totalCourtCost;
        }

        function addCreditToClient(clientName, amount) {
            const client = clients.find(c => c.name === clientName);
            if (client) {
                client.creditBalance = (client.creditBalance || 0) + amount;
                localStorage.setItem('clients', JSON.stringify(clients));
                showAlert(`Credit of AED ${amount.toFixed(2)} added to ${clientName}`, 'success');
            }
        }

        function loadSessions() {
            const tbody = document.getElementById('sessionsTableBody');
            tbody.innerHTML = '';
            
            // Sort sessions by date (newest first)
            const sortedSessions = [...sessions].sort((a, b) => {
                const dateA = parseLocalDate(a.date);
                const dateB = parseLocalDate(b.date);
                return dateB - dateA;
            });
            
            sortedSessions.forEach(session => {
                const client = clients.find(c => c.name === session.clientName);
                const creditIndicator = client && client.creditBalance > 0 ? 
                    `<span class="credit-indicator">Credit: AED ${client.creditBalance.toFixed(2)}</span>` : '';
                
                const packageIndicator = client && client.packages && client.packages.length > 0 ?
                    `<span class="package-indicator">Packages: ${client.packages.reduce((sum, p) => sum + p.balance, 0)}</span>` : '';
                
                const paymentDisplay = session.paymentMethod === 'Package' ? 
                    `<span class="status-badge status-package">Package</span>` : 
                    session.paymentMethod;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${session.sessionId}</td>
                    <td>${formatDateForDisplay(session.date)}</td>
                    <td>${session.time}</td>
                    <td>${session.clientName} ${creditIndicator} ${packageIndicator}</td>
                    <td>${session.location}</td>
                    <td>${session.sessionType}</td>
                    <td><span class="status-badge status-${session.paymentStatus.toLowerCase().replace(' ', '-')}">${session.paymentStatus}</span></td>
                    <td>${paymentDisplay}</td>
                    <td>AED ${session.totalRevenue.toFixed(2)}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="editSession(${session.id})" style="padding: 5px 10px; font-size: 12px;">Edit</button>
                        <button class="btn btn-danger" onclick="deleteSession(${session.id})" style="padding: 5px 10px; font-size: 12px;">Delete</button>
                        ${session.paymentStatus === 'Pending' ? 
                            `<button class="btn btn-success" onclick="markAsPaid(${session.id})" style="padding: 5px 10px; font-size: 12px;">Mark Paid</button>` : ''}
                        ${session.paymentStatus === 'Paid' ? 
                            `<button class="btn btn-danger" onclick="cancelSession(${session.id})" style="padding: 5px 10px; font-size: 12px;">Cancel</button>` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function editSession(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            // Populate the edit form with current session data
            document.getElementById('editSessionId').value = session.id;
            document.getElementById('editSessionDate').value = session.date;
            document.getElementById('editSessionTime').value = session.time;
            document.getElementById('editLocation').value = session.location;
            document.getElementById('editSessionType').value = session.sessionType;
            document.getElementById('editDuration').value = session.duration;
            document.getElementById('editInstructorName').value = session.instructorName;
            document.getElementById('editPaymentMethod').value = session.paymentMethod;
            document.getElementById('editPaymentStatus').value = session.paymentStatus;
            document.getElementById('editPricePerHour').value = session.pricePerHour;
            document.getElementById('editNumberOfStudents').value = session.numberOfStudents;
            document.getElementById('editCourtCostPerHour').value = session.courtCostPerHour;
            document.getElementById('editSessionNotes').value = session.notes || '';
            
            // Populate client dropdown
            const editClientSelect = document.getElementById('editClientSelect');
            editClientSelect.innerHTML = '<option value="">Select Client</option>';
            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.name;
                option.textContent = client.name;
                if (client.name === session.clientName) {
                    option.selected = true;
                }
                editClientSelect.appendChild(option);
            });
            
            // Handle custom location
            if (!['Top Padel', 'Champs', 'Padel Art'].includes(session.location)) {
                document.getElementById('editLocation').value = 'Other';
                document.getElementById('editCustomLocation').value = session.location;
                document.getElementById('editCustomLocationGroup').classList.remove('hidden');
            }
            
            document.getElementById('editSessionModal').style.display = 'block';
        }

        function updateSession(event) {
            event.preventDefault();
            
            const sessionId = parseInt(document.getElementById('editSessionId').value);
            const session = sessions.find(s => s.id === sessionId);
            
            if (!session) {
                showAlert('Session not found', 'danger');
                return;
            }
            
            // Get the location value
            const location = document.getElementById('editLocation').value === 'Other' 
                ? document.getElementById('editCustomLocation').value 
                : document.getElementById('editLocation').value;
            
            // Update session data
            session.date = document.getElementById('editSessionDate').value;
            session.time = document.getElementById('editSessionTime').value;
            session.location = location;
            session.sessionType = document.getElementById('editSessionType').value;
            session.duration = parseFloat(document.getElementById('editDuration').value);
            session.instructorName = document.getElementById('editInstructorName').value;
            session.clientName = document.getElementById('editClientSelect').value;
            session.paymentMethod = document.getElementById('editPaymentMethod').value;
            session.paymentStatus = document.getElementById('editPaymentStatus').value;
            session.pricePerHour = parseFloat(document.getElementById('editPricePerHour').value);
            session.numberOfStudents = parseInt(document.getElementById('editNumberOfStudents').value);
            session.courtCostPerHour = parseFloat(document.getElementById('editCourtCostPerHour').value);
            session.notes = document.getElementById('editSessionNotes').value;
            
            // Recalculate financials
            calculateSessionFinancials(session);
            
            // Save to localStorage
            localStorage.setItem('sessions', JSON.stringify(sessions));
            
            // Refresh displays
            loadSessions();
            updateDashboard();
            renderCalendar();
            
            // Close modal and show success message
            closeEditSessionModal();
            showAlert('Session updated successfully!', 'success');
        }

        function closeEditSessionModal() {
            document.getElementById('editSessionModal').style.display = 'none';
            document.getElementById('editCustomLocationGroup').classList.add('hidden');
            document.getElementById('editCustomLocation').value = '';
        }

        function deleteSession(sessionId) {
            if (confirm('Delete this session?')) {
                sessions = sessions.filter(s => s.id !== sessionId);
                localStorage.setItem('sessions', JSON.stringify(sessions));
                loadSessions();
                updateDashboard();
                renderCalendar();
                showAlert('Session deleted!', 'success');
            }
        }

        function markAsPaid(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (session) {
                session.paymentStatus = 'Paid';
                calculateSessionFinancials(session);
                localStorage.setItem('sessions', JSON.stringify(sessions));
                loadSessions();
                updateDashboard();
                renderCalendar();
                showAlert('Session marked as paid!', 'success');
            }
        }

        function cancelSession(sessionId) {
            if (confirm('Cancel this session? If paid, credit will be added to client.')) {
                const session = sessions.find(s => s.id === sessionId);
                if (session) {
                    if (session.paymentStatus === 'Paid' && session.totalRevenue > 0) {
                        addCreditToClient(session.clientName, session.totalRevenue);
                    }
                    session.paymentStatus = 'Canceled';
                    calculateSessionFinancials(session);
                    localStorage.setItem('sessions', JSON.stringify(sessions));
                    loadSessions();
                    loadClients();
                    updateDashboard();
                    renderCalendar();
                    showAlert('Session canceled!', 'success');
                }
            }
        }

        // Client Management
        function showAddClientForm() {
            document.getElementById('addClientForm').classList.remove('hidden');
        }

        function hideAddClientForm() {
            document.getElementById('addClientForm').classList.add('hidden');
            document.querySelector('#addClientForm form').reset();
        }

        function addClient(event) {
            event.preventDefault();
            
            const client = {
                id: Date.now(),
                name: document.getElementById('clientName').value,
                email: document.getElementById('clientEmail').value,
                phone: document.getElementById('clientPhone').value,
                leadSource: document.getElementById('clientLeadSource').value,
                notes: document.getElementById('clientNotes').value,
                creditBalance: 0,
                packages: [],
                createdDate: getLocalDateString(new Date())
            };

            clients.push(client);
            localStorage.setItem('clients', JSON.stringify(clients));
            
            loadClients();
            populateClientDropdowns();
            hideAddClientForm();
            updateDashboard();
            showAlert('Client added successfully!', 'success');
            
            // Auto-save to cloud
            autoSave();
        }

        function loadClients() {
            const tbody = document.getElementById('clientsTableBody');
            tbody.innerHTML = '';
            
            clients.forEach(client => {
                const clientSessions = sessions.filter(s => s.clientName === client.name);
                const totalSessions = clientSessions.length;
                const totalSpent = clientSessions.reduce((sum, s) => sum + s.totalRevenue, 0);
                const packageBalance = client.packages ? client.packages.reduce((sum, p) => sum + p.balance, 0) : 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${client.name}</td>
                    <td>${client.email}</td>
                    <td>${client.phone}</td>
                    <td>${totalSessions}</td>
                    <td>AED ${(client.creditBalance || 0).toFixed(2)}</td>
                    <td>${packageBalance} sessions</td>
                    <td>AED ${totalSpent.toFixed(2)}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="manageCredit(${client.id})" style="padding: 5px 10px; font-size: 12px;">Manage</button>
                        <button class="btn btn-danger" onclick="deleteClient(${client.id})" style="padding: 5px 10px; font-size: 12px;">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function deleteClient(clientId) {
            if (confirm('Delete this client?')) {
                clients = clients.filter(c => c.id !== clientId);
                localStorage.setItem('clients', JSON.stringify(clients));
                loadClients();
                populateClientDropdowns();
                updateDashboard();
                showAlert('Client deleted!', 'success');
            }
        }

        function manageCredit(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;
            
            const modal = document.getElementById('creditModal');
            const content = document.getElementById('creditContent');
            
            const packages = client.packages || [];
            let packagesHtml = '';
            
            packages.forEach(pkg => {
                packagesHtml += `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <span>${pkg.name} (${pkg.balance} sessions left)</span>
                        <button class="btn btn-danger" onclick="removePackage(${client.id}, '${pkg.id}')" style="padding: 2px 6px; font-size: 10px;">Remove</button>
                    </div>
                `;
            });
            
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h4>${client.name}</h4>
                    <p><strong>Current Credit:</strong> AED ${(client.creditBalance || 0).toFixed(2)}</p>
                </div>
                
                <div style="margin: 20px 0;">
                    <h4>Credit Management</h4>
                    <div class="form-group">
                        <label>Action:</label>
                        <select id="creditAction">
                            <option value="add">Add Credit</option>
                            <option value="deduct">Deduct Credit</option>
                            <option value="set">Set Credit</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Amount:</label>
                        <input type="number" id="creditAmount" step="0.01" min="0">
                    </div>
                    <button class="btn" onclick="updateCredit(${client.id})">Update Credit</button>
                </div>
                
                <div style="margin: 20px 0;">
                    <h4>Package Management</h4>
                    <div class="form-group">
                        <label>Package Name:</label>
                        <input type="text" id="packageName" placeholder="e.g., 10 Session Package">
                    </div>
                    <div class="form-group">
                        <label>Number of Sessions:</label>
                        <input type="number" id="packageSessions" min="1">
                    </div>
                    <div class="form-group">
                        <label>Package Price:</label>
                        <input type="number" id="packagePrice" step="0.01" min="0">
                    </div>
                    <button class="btn btn-success" onclick="addPackage(${client.id})">Add Package</button>
                </div>
                
                <div style="margin: 20px 0;">
                    <h4>Current Packages</h4>
                    ${packagesHtml || '<p>No packages</p>'}
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="closeCreditModal()">Close</button>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        function addPackage(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;
            
            const name = document.getElementById('packageName').value;
            const sessions = parseInt(document.getElementById('packageSessions').value);
            const price = parseFloat(document.getElementById('packagePrice').value);
            
            if (!name || !sessions || !price) {
                showAlert('Please fill all package fields', 'danger');
                return;
            }
            
            if (!client.packages) client.packages = [];
            
            const newPackage = {
                id: Date.now().toString(),
                name: name,
                totalSessions: sessions,
                balance: sessions,
                price: price,
                purchaseDate: getLocalDateString(new Date())
            };
            
            client.packages.push(newPackage);
            localStorage.setItem('clients', JSON.stringify(clients));
            
            manageCredit(clientId); // Refresh modal
            loadClients();
            showAlert(`Package "${name}" added successfully!`, 'success');
        }

        function removePackage(clientId, packageId) {
            if (confirm('Remove this package?')) {
                const client = clients.find(c => c.id === clientId);
                if (client && client.packages) {
                    client.packages = client.packages.filter(p => p.id !== packageId);
                    localStorage.setItem('clients', JSON.stringify(clients));
                    manageCredit(clientId); // Refresh modal
                    loadClients();
                    showAlert('Package removed!', 'success');
                }
            }
        }

        function updateCredit(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;
            
            const action = document.getElementById('creditAction').value;
            const amount = parseFloat(document.getElementById('creditAmount').value) || 0;
            const currentBalance = client.creditBalance || 0;
            
            switch (action) {
                case 'add':
                    client.creditBalance = currentBalance + amount;
                    break;
                case 'deduct':
                    client.creditBalance = Math.max(0, currentBalance - amount);
                    break;
                case 'set':
                    client.creditBalance = amount;
                    break;
            }
            
            localStorage.setItem('clients', JSON.stringify(clients));
            loadClients();
            loadSessions();
            updateDashboard();
            manageCredit(clientId); // Refresh modal
            showAlert(`Credit updated! New balance: AED ${client.creditBalance.toFixed(2)}`, 'success');
        }

        function closeCreditModal() {
            document.getElementById('creditModal').style.display = 'none';
        }

        function populateClientDropdowns() {
            const selects = ['clientSelect', 'calendarClientFilter'];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;
                
                const currentValue = select.value;
                
                // Clear existing options (except first ones)
                while (select.children.length > (selectId === 'clientSelect' ? 2 : 1)) {
                    select.removeChild(select.lastChild);
                }
                
                clients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.name;
                    option.textContent = client.name;
                    select.appendChild(option);
                });
                
                select.value = currentValue;
            });
        }

        // Expense Management
        function showAddExpenseForm() {
            document.getElementById('addExpenseForm').classList.remove('hidden');
        }

        function hideAddExpenseForm() {
            document.getElementById('addExpenseForm').classList.add('hidden');
            document.querySelector('#addExpenseForm form').reset();
            
            // Reset date to today
            const today = new Date();
            const localDate = new Date(today.getTime() - (today.getTimezoneOffset() * 60000));
            document.getElementById('expenseDate').value = localDate.toISOString().split('T')[0];
        }

        function addExpense(event) {
            event.preventDefault();
            
            const expense = {
                id: Date.now(),
                date: document.getElementById('expenseDate').value,
                category: document.getElementById('expenseCategory').value,
                amount: parseFloat(document.getElementById('expenseAmount').value),
                description: document.getElementById('expenseDescription').value
            };

            expenses.push(expense);
            localStorage.setItem('expenses', JSON.stringify(expenses));
            
            loadExpenses();
            hideAddExpenseForm();
            updateDashboard();
            showAlert('Expense added successfully!', 'success');
            
            // Auto-save to cloud
            autoSave();
        }

        function loadExpenses() {
            const tbody = document.getElementById('expensesTableBody');
            tbody.innerHTML = '';
            
            // Sort expenses by date (newest first)
            const sortedExpenses = [...expenses].sort((a, b) => {
                const dateA = parseLocalDate(a.date);
                const dateB = parseLocalDate(b.date);
                return dateB - dateA;
            });
            
            sortedExpenses.forEach(expense => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDateForDisplay(expense.date)}</td>
                    <td>${expense.category}</td>
                    <td>${expense.description}</td>
                    <td>AED ${expense.amount.toFixed(2)}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteExpense(${expense.id})" style="padding: 5px 10px; font-size: 12px;">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function deleteExpense(expenseId) {
            if (confirm('Delete this expense?')) {
                expenses = expenses.filter(e => e.id !== expenseId);
                localStorage.setItem('expenses', JSON.stringify(expenses));
                loadExpenses();
                updateDashboard();
                showAlert('Expense deleted!', 'success');
            }
        }

        // Target Management
        function showAddTargetForm() {
            document.getElementById('addTargetForm').classList.remove('hidden');
        }

        function hideAddTargetForm() {
            document.getElementById('addTargetForm').classList.add('hidden');
            document.querySelector('#addTargetForm form').reset();
        }

        function addTarget(event) {
            event.preventDefault();
            
            const target = {
                id: Date.now(),
                type: document.getElementById('targetType').value,
                period: document.getElementById('targetPeriod').value,
                year: parseInt(document.getElementById('targetYear').value),
                quarter: document.getElementById('targetQuarter').value,
                value: parseFloat(document.getElementById('targetValue').value)
            };

            targets.push(target);
            localStorage.setItem('targets', JSON.stringify(targets));
            
            loadTargets();
            hideAddTargetForm();
            showAlert('Target added successfully!', 'success');
        }

        function loadTargets() {
            // This will be called when targets page is shown
        }

        function renderTargets() {
            const container = document.getElementById('targetsContainer');
            container.innerHTML = '';
            
            const currentYear = new Date().getFullYear();
            const currentQuarter = Math.ceil((new Date().getMonth() + 1) / 3);
            
            targets.forEach(target => {
                const { achieved, percentage } = calculateTargetProgress(target);
                
                const progressColor = percentage >= 100 ? '#2ed573' : percentage >= 75 ? '#ffa502' : '#ff4757';
                
                const card = document.createElement('div');
                card.className = 'target-card';
                card.innerHTML = `
                    <h4>${target.type.charAt(0).toUpperCase() + target.type.slice(1)} Target - ${target.period === 'quarterly' ? `Q${target.quarter} ` : ''}${target.year}</h4>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin: 15px 0;">
                        <span><strong>Target:</strong> ${target.type === 'sessions' ? target.value : `AED ${target.value.toFixed(2)}`}</span>
                        <span><strong>Achieved:</strong> ${target.type === 'sessions' ? achieved : `AED ${achieved.toFixed(2)}`}</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${Math.min(percentage, 100)}%; background: ${progressColor};"></div>
                    </div>
                    <div style="text-align: center; margin-top: 10px;">
                        <strong>${percentage.toFixed(1)}% Complete</strong>
                    </div>
                    <button class="btn btn-danger" onclick="deleteTarget(${target.id})" style="margin-top: 10px; padding: 5px 10px; font-size: 12px;">Delete</button>
                `;
                container.appendChild(card);
            });
            
            if (targets.length === 0) {
                container.innerHTML = '<p>No targets set. Click "Set New Target" to add one.</p>';
            }
        }

        function calculateTargetProgress(target) {
            let filteredSessions = [];
            const currentDate = new Date();
            
            if (target.period === 'quarterly') {
                const startMonth = (target.quarter - 1) * 3;
                const endMonth = startMonth + 2;
                
                filteredSessions = sessions.filter(session => {
                    const sessionDate = parseLocalDate(session.date);
                    return sessionDate.getFullYear() === target.year &&
                           sessionDate.getMonth() >= startMonth &&
                           sessionDate.getMonth() <= endMonth;
                });
            } else {
                filteredSessions = sessions.filter(session => {
                    const sessionDate = parseLocalDate(session.date);
                    return sessionDate.getFullYear() === target.year;
                });
            }
            
            let achieved = 0;
            
            switch (target.type) {
                case 'sessions':
                    achieved = filteredSessions.length;
                    break;
                case 'revenue':
                    achieved = filteredSessions.reduce((sum, s) => sum + s.totalRevenue, 0);
                    break;
                case 'profit':
                    const totalRevenue = filteredSessions.reduce((sum, s) => sum + s.totalRevenue, 0);
                    const totalCourtCosts = filteredSessions.reduce((sum, s) => sum + (s.duration * s.courtCostPerHour), 0);
                    
                    const periodExpenses = expenses.filter(expense => {
                        const expenseDate = parseLocalDate(expense.date);
                        if (target.period === 'quarterly') {
                            const startMonth = (target.quarter - 1) * 3;
                            const endMonth = startMonth + 2;
                            return expenseDate.getFullYear() === target.year &&
                                   expenseDate.getMonth() >= startMonth &&
                                   expenseDate.getMonth() <= endMonth;
                        } else {
                            return expenseDate.getFullYear() === target.year;
                        }
                    });
                    
                    const totalExpenses = periodExpenses.reduce((sum, e) => sum + e.amount, 0);
                    achieved = totalRevenue - totalCourtCosts - totalExpenses;
                    break;
            }
            
            const percentage = (achieved / target.value) * 100;
            return { achieved, percentage };
        }

        function deleteTarget(targetId) {
            if (confirm('Delete this target?')) {
                targets = targets.filter(t => t.id !== targetId);
                localStorage.setItem('targets', JSON.stringify(targets));
                renderTargets();
                showAlert('Target deleted!', 'success');
            }
        }

        // Dashboard
        function updateDashboard() {
            const totalSessions = sessions.length;
            const totalRevenue = sessions.reduce((sum, s) => sum + s.totalRevenue, 0);
            const totalCourtCosts = sessions.reduce((sum, s) => sum + (s.duration * s.courtCostPerHour), 0);
            const totalProfit = totalRevenue - totalCourtCosts;
            const totalClients = clients.length;
            const totalCredits = clients.reduce((sum, c) => sum + (c.creditBalance || 0), 0);
            const totalPackages = clients.reduce((sum, c) => {
                if (c.packages) {
                    return sum + c.packages.reduce((pkgSum, p) => pkgSum + p.balance, 0);
                }
                return sum;
            }, 0);
            
            document.getElementById('totalSessions').textContent = totalSessions;
            document.getElementById('totalRevenue').textContent = `AED ${totalRevenue.toFixed(2)}`;
            document.getElementById('totalProfit').textContent = `AED ${totalProfit.toFixed(2)}`;
            document.getElementById('totalClients').textContent = totalClients;
            document.getElementById('totalCredits').textContent = `AED ${totalCredits.toFixed(2)}`;
            document.getElementById('totalPackages').textContent = `${totalPackages} sessions`;
        }

        // Calendar rendering
        function renderCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            const clientFilter = document.getElementById('calendarClientFilter').value;
            
            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"];
            document.getElementById('currentMonthYear').textContent = `${monthNames[month]} ${year}`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            // Start calendar from Sunday of the week containing the first day
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            const today = new Date();
            const todayString = getLocalDateString(today);
            
            let calendarHTML = '<table style="width: 100%; border-collapse: collapse;">';
            calendarHTML += '<tr>';
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayNames.forEach(day => {
                calendarHTML += `<th style="padding: 10px; background: #667eea; color: white; text-align: center;">${day}</th>`;
            });
            calendarHTML += '</tr>';
            
            for (let week = 0; week < 6; week++) {
                calendarHTML += '<tr>';
                for (let day = 0; day < 7; day++) {
                    const currentDate = new Date(startDate);
                    currentDate.setDate(startDate.getDate() + (week * 7) + day);
                    
                    const dateStr = getLocalDateString(currentDate);
                    let daySessions = sessions.filter(s => s.date === dateStr);
                    
                    if (clientFilter) {
                        daySessions = daySessions.filter(s => s.clientName === clientFilter);
                    }
                    
                    const isCurrentMonth = currentDate.getMonth() === month;
                    const isToday = dateStr === todayString;
                    
                    let cellClasses = ['calendar-day'];
                    let cellStyle = 'padding: 10px; border: 1px solid #ddd; vertical-align: top; min-height: 100px; position: relative;';
                    
                    if (!isCurrentMonth) {
                        cellClasses.push('other-month');
                        cellStyle += ' background: #f8f9fa; color: #6c757d;';
                    } else {
                        cellStyle += ' background: white;';
                    }
                    
                    if (isToday) {
                        cellClasses.push('today');
                        cellStyle += ' background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;';
                    }
                    
                    calendarHTML += `<td class="${cellClasses.join(' ')}" style="${cellStyle}">`;
                    calendarHTML += `<div style="font-weight: bold; margin-bottom: 5px;">${currentDate.getDate()}</div>`;
                    
                    // Display sessions
                    daySessions.slice(0, 4).forEach(session => {
                        const statusColor = getSessionColor(session.paymentStatus);
                        const shortName = session.clientName.length > 10 ? 
                            session.clientName.substring(0, 10) + '...' : session.clientName;
                        
                        calendarHTML += `<div style="background: ${statusColor}; color: white; padding: 2px 4px; margin: 1px 0; border-radius: 3px; font-size: 10px; overflow: hidden; white-space: nowrap;" title="${session.time} - ${session.clientName} (${session.paymentStatus})">${session.time} ${shortName}</div>`;
                    });
                    
                    if (daySessions.length > 4) {
                        calendarHTML += `<div style="font-size: 10px; color: ${isToday ? 'rgba(255,255,255,0.8)' : '#666'}; margin-top: 2px;">+${daySessions.length - 4} more</div>`;
                    }
                    
                    calendarHTML += '</td>';
                }
                calendarHTML += '</tr>';
            }
            calendarHTML += '</table>';
            
            document.getElementById('calendarContainer').innerHTML = calendarHTML;
        }

        function getSessionColor(paymentStatus) {
            switch (paymentStatus) {
                case 'Paid': return '#2ed573';
                case 'Pending': return '#ffa502';
                case 'Canceled': return '#ff4757';
                case 'Free Session': return '#747d8c';
                default: return '#3742fa';
            }
        }

        function previousMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderCalendar();
        }

        function goToToday() {
            currentCalendarDate = new Date();
            renderCalendar();
        }

        // Reports
        function generateSessionsReport() {
            const reportType = document.getElementById('sessionsReportType').value;
            const year = parseInt(document.getElementById('reportYear').value);
            const month = document.getElementById('reportMonth').value;
            
            if (!year) {
                showAlert('Please select a year', 'danger');
                return;
            }
            
            let filteredSessions = sessions.filter(session => {
                const sessionDate = parseLocalDate(session.date);
                return sessionDate.getFullYear() === year;
            });
            
            let reportHTML = '';
            currentReportData = null;
            
            switch (reportType) {
                case 'monthly':
                    if (month) {
                        filteredSessions = filteredSessions.filter(session => {
                            const sessionDate = parseLocalDate(session.date);
                            return sessionDate.getMonth() + 1 === parseInt(month);
                        });
                    }
                    reportHTML = generateMonthlyReport(filteredSessions, year, month);
                    break;
                    
                case 'yearly':
                    reportHTML = generateYearlyReport(filteredSessions, year);
                    break;
                    
                case 'location':
                    reportHTML = generateLocationReport(filteredSessions, year);
                    break;
                    
                case 'timing':
                    reportHTML = generateTimingReport(filteredSessions, year);
                    break;
            }
            
            document.getElementById('reportContent').innerHTML = reportHTML;
            document.getElementById('reportResults').classList.remove('hidden');
        }

        function generateMonthlyReport(filteredSessions, year, month) {
            const monthNames = ["All Months", "January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"];
            
            let reportData = {};
            
            if (month) {
                // Single month report
                const monthName = monthNames[parseInt(month)];
                reportData[monthName] = filteredSessions;
            } else {
                // All months report
                for (let m = 1; m <= 12; m++) {
                    const monthName = monthNames[m];
                    reportData[monthName] = filteredSessions.filter(session => {
                        const sessionDate = parseLocalDate(session.date);
                        return sessionDate.getMonth() + 1 === m;
                    });
                }
            }
            
            currentReportData = {
                type: 'monthly',
                year: year,
                month: month,
                data: reportData
            };
            
            let html = `<div style="background: white; padding: 20px; border-radius: 10px;">
                <h3>Sessions per Month - ${year}</h3>
                <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                    <tr style="background: #f5f5f5;">
                        <th style="padding: 10px; border: 1px solid #ddd;">Month</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">Total Sessions</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">Total Revenue</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">Avg Sessions/Day</th>
                    </tr>`;
            
            Object.entries(reportData).forEach(([monthName, sessions]) => {
                const totalSessions = sessions.length;
                const totalRevenue = sessions.reduce((sum, s) => sum + s.totalRevenue, 0);
                const daysInMonth = monthName === "All Months" ? 365 : 30; // Simplified
                const avgPerDay = (totalSessions / daysInMonth).toFixed(1);
                
                html += `<tr>
                    <td style="padding: 10px; border: 1px solid #ddd;">${monthName}</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">${totalSessions}</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">AED ${totalRevenue.toFixed(2)}</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">${avgPerDay}</td>
                </tr>`;
            });
            
            html += '</table></div>';
            return html;
        }

        function generateYearlyReport(filteredSessions, year) {
            const totalSessions = filteredSessions.length;
            const totalRevenue = filteredSessions.reduce((sum, s) => sum + s.totalRevenue, 0);
            const avgPerMonth = (totalSessions / 12).toFixed(1);
            
            // Group by session type
            const byType = {};
            filteredSessions.forEach(session => {
                if (!byType[session.sessionType]) {
                    byType[session.sessionType] = [];
                }
                byType[session.sessionType].push(session);
            });
            
            currentReportData = {
                type: 'yearly',
                year: year,
                data: filteredSessions
            };
            
            let html = `<div style="background: white; padding: 20px; border-radius: 10px;">
                <h3>Yearly Report - ${year}</h3>
                <div style="margin: 20px 0;">
                    <p><strong>Total Sessions:</strong> ${totalSessions}</p>
                    <p><strong>Total Revenue:</strong> AED ${totalRevenue.toFixed(2)}</p>
                    <p><strong>Average Sessions per Month:</strong> ${avgPerMonth}</p>
                </div>
                
                <h4>Sessions by Type</h4>
                <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                    <tr style="background: #f5f5f5;">
                        <th style="padding: 10px; border: 1px solid #ddd;">Session Type</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">Count</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">Percentage</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">Revenue</th>
                    </tr>`;
            
            Object.entries(byType).forEach(([type, sessions]) => {
                const count = sessions.length;
                const percentage = ((count / totalSessions) * 100).toFixed(1);
                const revenue = sessions.reduce((sum, s) => sum + s.totalRevenue, 0);
                
                html += `<tr>
                    <td style="padding: 10px; border: 1px solid #ddd;">${type}</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">${count}</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">${percentage}%</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">AED ${revenue.toFixed(2)}</td>
                </tr>`;
            });
            
            html += '</table></div>';
            return html;
        }

        function generateLocationReport(filteredSessions, year) {
            const byLocation = {};
            filteredSessions.forEach(session => {
                if (!byLocation[session.location]) {
                    byLocation[session.location] = [];
                }
                byLocation[session.location].push(session);
            });
            
            currentReportData = {
                type: 'location',
                year: year,
                data: byLocation
            };
            
            let html = `<div style="background: white; padding: 20px; border-radius: 10px;">
                <h3>Sessions by Location - ${year}</h3>
                <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                    <tr style="background: #f5f5f5;">
                        <th style="padding: 10px; border: 1px solid #ddd;">Location</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">Total Sessions</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">Total Revenue</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">Avg Revenue per Session</th>
                    </tr>`;
            
            Object.entries(byLocation).forEach(([location, sessions]) => {
                const totalSessions = sessions.length;
                const totalRevenue = sessions.reduce((sum, s) => sum + s.totalRevenue, 0);
                const avgRevenue = totalSessions > 0 ? (totalRevenue / totalSessions).toFixed(2) : 0;
                
                html += `<tr>
                    <td style="padding: 10px; border: 1px solid #ddd;">${location}</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">${totalSessions}</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">AED ${totalRevenue.toFixed(2)}</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">AED ${avgRevenue}</td>
                </tr>`;
            });
            
            html += '</table></div>';
            return html;
        }

        function generateTimingReport(filteredSessions, year) {
            const byHour = {};
            const byTimeOfDay = {
                'Morning (6-12)': [],
                'Afternoon (12-18)': [],
                'Evening (18-24)': []
            };
            
            filteredSessions.forEach(session => {
                const hour = parseInt(session.time.split(':')[0]);
                
                if (!byHour[hour]) byHour[hour] = [];
                byHour[hour].push(session);
                
                if (hour >= 6 && hour < 12) {
                    byTimeOfDay['Morning (6-12)'].push(session);
                } else if (hour >= 12 && hour < 18) {
                    byTimeOfDay['Afternoon (12-18)'].push(session);
                } else if (hour >= 18 && hour < 24) {
                    byTimeOfDay['Evening (18-24)'].push(session);
                }
            });
            
            currentReportData = {
                type: 'timing',
                year: year,
                data: { byHour, byTimeOfDay }
            };
            
            let html = `<div style="background: white; padding: 20px; border-radius: 10px;">
                <h3>Session Timing Analysis - ${year}</h3>
                
                <h4>Sessions by Time of Day</h4>
                <table style="width: 100%; border-collapse: collapse; margin: 15px 0;">
                    <tr style="background: #f5f5f5;">
                        <th style="padding: 10px; border: 1px solid #ddd;">Time Period</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">Sessions</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">Percentage</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">Revenue</th>
                    </tr>`;
            
            Object.entries(byTimeOfDay).forEach(([period, sessions]) => {
                const count = sessions.length;
                const percentage = ((count / filteredSessions.length) * 100).toFixed(1);
                const revenue = sessions.reduce((sum, s) => sum + s.totalRevenue, 0);
                
                html += `<tr>
                    <td style="padding: 10px; border: 1px solid #ddd;">${period}</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">${count}</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">${percentage}%</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">AED ${revenue.toFixed(2)}</td>
                </tr>`;
            });
            
            html += '</table>';
            
            // Peak hours
            const sortedHours = Object.entries(byHour)
                .sort(([,a], [,b]) => b.length - a.length)
                .slice(0, 5);
            
            html += `<h4>Top 5 Peak Hours</h4>
                <table style="width: 100%; border-collapse: collapse; margin: 15px 0;">
                    <tr style="background: #f5f5f5;">
                        <th style="padding: 10px; border: 1px solid #ddd;">Hour</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">Sessions</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">Revenue</th>
                    </tr>`;
            
            sortedHours.forEach(([hour, sessions]) => {
                const formattedHour = `${hour.padStart(2, '0')}:00`;
                const revenue = sessions.reduce((sum, s) => sum + s.totalRevenue, 0);
                
                html += `<tr>
                    <td style="padding: 10px; border: 1px solid #ddd;">${formattedHour}</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">${sessions.length}</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">AED ${revenue.toFixed(2)}</td>
                </tr>`;
            });
            
            html += '</table></div>';
            return html;
        }

        function generateFinancialReport() {
            const totalRevenue = sessions.reduce((sum, s) => sum + s.totalRevenue, 0);
            const totalCourtCosts = sessions.reduce((sum, s) => sum + (s.duration * s.courtCostPerHour), 0);
            const totalExpenses = expenses.reduce((sum, e) => sum + e.amount, 0);
            const grossProfit = totalRevenue - totalCourtCosts;
            const netProfit = grossProfit - totalExpenses;
            
            const reportHTML = `
                <div style="background: white; padding: 20px; border-radius: 10px;">
                    <h3>Financial Report</h3>
                    <div style="margin: 20px 0;">
                        <p><strong>Total Revenue:</strong> AED ${totalRevenue.toFixed(2)}</p>
                        <p><strong>Court Costs:</strong> AED ${totalCourtCosts.toFixed(2)}</p>
                        <p><strong>Gross Profit:</strong> AED ${grossProfit.toFixed(2)}</p>
                        <p><strong>Other Expenses:</strong> AED ${totalExpenses.toFixed(2)}</p>
                        <p><strong>Net Profit:</strong> AED ${netProfit.toFixed(2)}</p>
                        <hr style="margin: 15px 0;">
                        <p><strong>Total Sessions:</strong> ${sessions.length}</p>
                        <p><strong>Average Revenue per Session:</strong> AED ${sessions.length > 0 ? (totalRevenue / sessions.length).toFixed(2) : 0}</p>
                        <p><strong>Average Gross Profit per Session:</strong> AED ${sessions.length > 0 ? (grossProfit / sessions.length).toFixed(2) : 0}</p>
                    </div>
                </div>
            `;
            
            document.getElementById('reportContent').innerHTML = reportHTML;
            document.getElementById('reportResults').classList.remove('hidden');
        }

        function generatePendingPayments() {
            const pendingSessions = sessions.filter(s => s.paymentStatus === 'Pending');
            const totalPending = pendingSessions.reduce((sum, s) => sum + s.totalRevenue, 0);
            
            let reportHTML = `
                <div style="background: white; padding: 20px; border-radius: 10px;">
                    <h3>Pending Payments Report</h3>
                    <p><strong>Total Pending:</strong> AED ${totalPending.toFixed(2)} (${pendingSessions.length} sessions)</p>
                    <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                        <tr style="background: #f5f5f5;">
                            <th style="padding: 8px; border: 1px solid #ddd;">Date</th>
                            <th style="padding: 8px; border: 1px solid #ddd;">Client</th>
                            <th style="padding: 8px; border: 1px solid #ddd;">Amount</th>
                        </tr>
            `;
            
            pendingSessions.forEach(session => {
                reportHTML += `
                    <tr>
                        <td style="padding: 8px; border: 1px solid #ddd;">${formatDateForDisplay(session.date)}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${session.clientName}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">AED ${session.totalRevenue.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            reportHTML += '</table></div>';
            
            document.getElementById('reportContent').innerHTML = reportHTML;
            document.getElementById('reportResults').classList.remove('hidden');
        }

        function generateTargetProgressReport() {
            if (targets.length === 0) {
                showAlert('No targets set. Please set targets first.', 'warning');
                return;
            }
            
            let reportHTML = `
                <div style="background: white; padding: 20px; border-radius: 10px;">
                    <h3>Target Progress Report</h3>
                    <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                        <tr style="background: #f5f5f5;">
                            <th style="padding: 10px; border: 1px solid #ddd;">Target</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">Period</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">Target Value</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">Achieved</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">Progress</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">Status</th>
                        </tr>
            `;
            
            targets.forEach(target => {
                const { achieved, percentage } = calculateTargetProgress(target);
                const status = percentage >= 100 ? 'Completed' : percentage >= 75 ? 'On Track' : 'Behind';
                const statusColor = percentage >= 100 ? '#2ed573' : percentage >= 75 ? '#ffa502' : '#ff4757';
                
                const periodText = target.period === 'quarterly' ? `Q${target.quarter} ${target.year}` : target.year;
                const targetValue = target.type === 'sessions' ? target.value : `AED ${target.value.toFixed(2)}`;
                const achievedValue = target.type === 'sessions' ? achieved : `AED ${achieved.toFixed(2)}`;
                
                reportHTML += `
                    <tr>
                        <td style="padding: 10px; border: 1px solid #ddd;">${target.type.charAt(0).toUpperCase() + target.type.slice(1)}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${periodText}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${targetValue}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${achievedValue}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${percentage.toFixed(1)}%</td>
                        <td style="padding: 10px; border: 1px solid #ddd; color: ${statusColor}; font-weight: bold;">${status}</td>
                    </tr>
                `;
            });
            
            reportHTML += '</table></div>';
            
            document.getElementById('reportContent').innerHTML = reportHTML;
            document.getElementById('reportResults').classList.remove('hidden');
        }

        // Download functions
        function downloadReportExcel() {
            if (!currentReportData) {
                showAlert('Please generate a report first', 'warning');
                return;
            }
            
            let csvContent = '';
            const filename = `padel_report_${currentReportData.type}_${Date.now()}.csv`;
            
            switch (currentReportData.type) {
                case 'monthly':
                    csvContent = 'Month,Total Sessions,Total Revenue,Avg Sessions per Day\n';
                    Object.entries(currentReportData.data).forEach(([month, sessions]) => {
                        const totalSessions = sessions.length;
                        const totalRevenue = sessions.reduce((sum, s) => sum + s.totalRevenue, 0);
                        const avgPerDay = (totalSessions / 30).toFixed(1);
                        csvContent += `"${month}","${totalSessions}","${totalRevenue.toFixed(2)}","${avgPerDay}"\n`;
                    });
                    break;
                    
                case 'yearly':
                    csvContent = 'Session ID,Date,Time,Client,Location,Type,Status,Revenue\n';
                    currentReportData.data.forEach(session => {
                        csvContent += `"${session.sessionId}","${session.date}","${session.time}","${session.clientName}","${session.location}","${session.sessionType}","${session.paymentStatus}","${session.totalRevenue}"\n`;
                    });
                    break;
                    
                case 'location':
                    csvContent = 'Location,Total Sessions,Total Revenue,Avg Revenue per Session\n';
                    Object.entries(currentReportData.data).forEach(([location, sessions]) => {
                        const totalSessions = sessions.length;
                        const totalRevenue = sessions.reduce((sum, s) => sum + s.totalRevenue, 0);
                        const avgRevenue = totalSessions > 0 ? (totalRevenue / totalSessions).toFixed(2) : 0;
                        csvContent += `"${location}","${totalSessions}","${totalRevenue.toFixed(2)}","${avgRevenue}"\n`;
                    });
                    break;
                    
                case 'timing':
                    csvContent = 'Time Period,Sessions,Percentage,Revenue\n';
                    Object.entries(currentReportData.data.byTimeOfDay).forEach(([period, sessions]) => {
                        const count = sessions.length;
                        const totalSessions = Object.values(currentReportData.data.byTimeOfDay).reduce((sum, arr) => sum + arr.length, 0);
                        const percentage = ((count / totalSessions) * 100).toFixed(1);
                        const revenue = sessions.reduce((sum, s) => sum + s.totalRevenue, 0);
                        csvContent += `"${period}","${count}","${percentage}","${revenue.toFixed(2)}"\n`;
                    });
                    break;
            }
            
            downloadCSV(csvContent, filename);
            showAlert('Report downloaded as Excel/CSV!', 'success');
        }

        function downloadReportPDF() {
            if (!currentReportData) {
                showAlert('Please generate a report first', 'warning');
                return;
            }
            
            // Create a simple HTML version for PDF
            const reportContent = document.getElementById('reportContent').innerHTML;
            const htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Padel Academy Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        table { border-collapse: collapse; width: 100%; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        h3, h4 { color: #333; }
                    </style>
                </head>
                <body>
                    ${reportContent}
                    <p style="margin-top: 30px; font-size: 12px; color: #666;">
                        Generated on ${new Date().toLocaleString()} | Padel Academy Management System
                    </p>
                </body>
                </html>
            `;
            
            // Create blob and download
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `padel_report_${currentReportData.type}_${Date.now()}.html`;
            link.click();
            
            showAlert('Report downloaded as HTML (can be saved as PDF from browser)!', 'info');
        }

        // Export functions
        function exportSessions() {
            const csv = 'Session ID,Date,Time,Client,Location,Type,Status,Payment Method,Revenue,Notes\n' +
                sessions.map(s => `"${s.sessionId}","${s.date}","${s.time}","${s.clientName}","${s.location}","${s.sessionType}","${s.paymentStatus}","${s.paymentMethod}","${s.totalRevenue}","${s.notes || ''}"`).join('\n');
            downloadCSV(csv, 'sessions_export.csv');
        }

        function exportClients() {
            const csv = 'Name,Email,Phone,Lead Source,Credit Balance,Package Balance,Total Sessions,Total Spent\n' +
                clients.map(c => {
                    const clientSessions = sessions.filter(s => s.clientName === c.name);
                    const totalSpent = clientSessions.reduce((sum, s) => sum + s.totalRevenue, 0);
                    const packageBalance = c.packages ? c.packages.reduce((sum, p) => sum + p.balance, 0) : 0;
                    return `"${c.name}","${c.email}","${c.phone}","${c.leadSource}","${c.creditBalance || 0}","${packageBalance}","${clientSessions.length}","${totalSpent}"`;
                }).join('\n');
            downloadCSV(csv, 'clients_export.csv');
        }

        function exportExpenses() {
            const csv = 'Date,Category,Description,Amount\n' +
                expenses.map(e => `"${e.date}","${e.category}","${e.description}","${e.amount}"`).join('\n');
            downloadCSV(csv, 'expenses_export.csv');
        }

        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        // Backup functions
        function backupAllData() {
            const data = {
                sessions,
                clients,
                expenses,
                targets,
                nextSessionId,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `padel_academy_backup_${getLocalDateString(new Date()).replace(/-/g, '_')}.json`;
            link.click();
            
            showAlert('Backup downloaded successfully!', 'success');
        }

        function restoreData() {
            document.getElementById('restoreFile').click();
        }

        function handleRestore(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (confirm('This will replace all current data. Continue?')) {
                        sessions = data.sessions || [];
                        clients = data.clients || [];
                        expenses = data.expenses || [];
                        targets = data.targets || [];
                        nextSessionId = data.nextSessionId || 1;
                        
                        localStorage.setItem('sessions', JSON.stringify(sessions));
                        localStorage.setItem('clients', JSON.stringify(clients));
                        localStorage.setItem('expenses', JSON.stringify(expenses));
                        localStorage.setItem('targets', JSON.stringify(targets));
                        localStorage.setItem('nextSessionId', nextSessionId.toString());
                        
                        loadSessions();
                        loadClients();
                        loadExpenses();
                        loadTargets();
                        populateClientDropdowns();
                        updateDashboard();
                        renderCalendar();
                        renderTargets();
                        
                        showAlert('Data restored successfully!', 'success');
                    }
                } catch (error) {
                    showAlert('Error reading backup file: ' + error.message, 'danger');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function clearAllData() {
            if (confirm('This will delete ALL data permanently. Are you sure?')) {
                if (confirm('Last chance! This cannot be undone.')) {
                    sessions = [];
                    clients = [];
                    expenses = [];
                    targets = [];
                    nextSessionId = 1;
                    
                    localStorage.clear();
                    
                    loadSessions();
                    loadClients();
                    loadExpenses();
                    loadTargets();
                    populateClientDropdowns();
                    updateDashboard();
                    renderCalendar();
                    renderTargets();
                    
                    showAlert('All data cleared!', 'success');
                }
            }
        }

        // Utility functions
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.container').firstChild);
            
            setTimeout(() => alertDiv.remove(), 5000);
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>